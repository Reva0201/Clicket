<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Payment</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
    }
    .center-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 500px;
      width: 100%;
      padding: 40px;
      box-sizing: border-box;
      max-width: 96vw;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    #payment-summary {
      background: #e3f2fd;
      border-left: 4px solid #1976d2;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 24px;
      font-weight: 600;
      color: #1565c0;
    }
    .payment-method-section {
      margin-bottom: 24px;
    }
    .payment-method-section h3 {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    .payment-methods {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .method-option {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    .method-option:hover {
      border-color: #1976d2;
      background: #f5f5f5;
    }
    .method-option.active {
      border-color: #1976d2;
      background: #e3f2fd;
    }
    .method-option input[type="radio"] {
      display: none;
    }
    .method-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .method-name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    form > div {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: 500;
      font-size: 13px;
    }
    input[type="text"], input[type="email"], input[type="tel"], select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, select:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
    }
    input[type="text"]::placeholder {
      color: #999;
    }
    button[type="submit"] {
      width: 100%;
      padding: 12px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.3s;
    }
    button[type="submit"]:hover {
      background: #1565c0;
    }
    button[type="submit"]:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #back-ticket {
      width: 100%;
      padding: 10px;
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }
    #back-ticket:hover {
      background: #e0e0e0;
    }
    #payment-message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-weight: 500;
    }
    #payment-message.success {
      background: #c8e6c9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }
    #payment-message.error {
      background: #ffcdd2;
      color: #c62828;
      border: 1px solid #ef5350;
    }
    .hidden-form {
      display: none;
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
      .center-container { padding: 20px; }
      .payment-methods { grid-template-columns: 1fr; }
      .method-icon { font-size: 28px; }
      h2 { font-size: 20px; }
      button[type="submit"] { padding: 10px; font-size: 15px; }
    }
    @media (max-width: 420px) {
      .center-container { padding: 12px; }
      .method-icon { font-size: 24px; }
      .method-name { font-size: 13px; }
    }
    /* Ensure very small devices stay readable */
    @media (max-width: 360px) {
      body { padding: 12px; }
      h2 { font-size: 18px; }
      label { font-size: 12px; }
      input, select { font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="center-container">
    <h2>Checkout</h2>
    <div id="payment-summary"></div>

    <!-- Payment Method Selection -->
    <div class="payment-method-section">
      <h3>Select Payment Method</h3>
      <div class="payment-methods">
        <label class="method-option active" data-method="card">
          <input type="radio" name="payment-method" value="card" checked>
          <div class="method-icon">üí≥</div>
          <div class="method-name">Credit/Debit Card</div>
        </label>
        <label class="method-option" data-method="ewallet">
          <input type="radio" name="payment-method" value="ewallet">
          <div class="method-icon">üì±</div>
          <div class="method-name">E-Wallet</div>
        </label>
        <label class="method-option" data-method="bank">
          <input type="radio" name="payment-method" value="bank">
          <div class="method-icon">üè¶</div>
          <div class="method-name">Bank Transfer</div>
        </label>
      </div>
    </div>

    <!-- Credit Card Form -->
    <form id="card-form" class="payment-form">
      <div>
        <label for="card-holder">Card Holder Name:</label>
        <input type="text" id="card-holder" placeholder="John Doe" required>
      </div>
      <div>
        <label for="card-number">Card Number:</label>
        <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label for="card-expiry">Expiry (MM/YY):</label>
          <input type="text" id="card-expiry" placeholder="12/25" maxlength="5" required>
        </div>
        <div>
          <label for="card-cvv">CVV:</label>
          <input type="text" id="card-cvv" placeholder="123" maxlength="3" required>
        </div>
      </div>
      <button type="submit">Pay Now</button>
    </form>

    <!-- E-Wallet Form -->
    <form id="ewallet-form" class="payment-form hidden-form">
      <div>
        <label for="ewallet-provider">Provider:</label>
        <select id="ewallet-provider" required>
          <option value="">Select E-Wallet Provider</option>
          <option value="gcash">GCash</option>
          <option value="paypal">PayPal</option>
          <option value="grabpay">GrabPay</option>
        </select>
      </div>
      <div>
        <label for="ewallet-phone">Phone/Email:</label>
        <input type="text" id="ewallet-phone" placeholder="09xxxxxxxxx or email@example.com" required>
      </div>
      <button type="submit">Pay Now</button>
    </form>

    <!-- Bank Transfer Form -->
    <form id="bank-form" class="payment-form hidden-form">
      <div>
        <label for="bank-name">Bank Name:</label>
        <select id="bank-name" required>
          <option value="">Select Bank</option>
          <option value="bdo">BDO</option>
          <option value="bpi">BPI</option>
          <option value="metrobank">Metrobank</option>
          <option value="unionbank">UnionBank</option>
        </select>
      </div>
      <div>
        <label for="bank-account">Account Number:</label>
        <input type="text" id="bank-account" placeholder="Your bank account number" required>
      </div>
      <div>
        <label for="bank-name-acc">Account Holder Name:</label>
        <input type="text" id="bank-name-acc" placeholder="Your name" required>
      </div>
      <button type="submit">Confirm Transfer</button>
    </form>

    <div id="payment-message"></div>
    <button id="back-ticket">‚Üê Back to Tickets</button>
  </div>

  <script>
    // Parse query params
    function getQueryParams() {
      const params = {};
      window.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function(_, k, v) {
        params[k] = decodeURIComponent(v);
      });
      return params;
    }

    const params = getQueryParams();
    const eventNames = { theater: 'Theater', concert: 'Concert', f1: 'F1', vct: 'VCT Valorant' };
    const eventPrices = { theater: 750000, concert: 1000000, f1: 2000000, vct: 1500000 };
    const event = params.event;
    const quantity = params.quantity ? parseInt(params.quantity, 10) : NaN;

    // Resolve event info: supports shorthand keys (theater, concert, etc.)
    // or full event records (from /events) where `event` can be an id or name.
    async function resolveEventInfo(evtParam) {
      // direct mapping (short keys)
      if (evtParam && eventNames[evtParam]) {
        return {
          id: evtParam,
          name: eventNames[evtParam],
          prices: [{ price: eventPrices[evtParam], stock: Infinity }]
        };
      }

      // try fetching events from server and match by id or name
      try {
        const res = await fetch('/events');
        if (!res.ok) return null;
        const events = await res.json();
        // match by numeric id first
        let found = events.find(e => String(e.id) === String(evtParam));
        if (!found) {
          // match by name (case-insensitive)
          found = events.find(e => e.name && String(e.name).trim().toLowerCase() === String(evtParam).trim().toLowerCase());
        }
        if (found) {
          // ensure prices sorted ascending
          found.prices = (found.prices || []).slice().sort((a, b) => a.price - b.price);
          return found;
        }
      } catch (err) {
        console.warn('Failed to fetch events for payment page', err);
      }
      return null;
    }

    (async function init() {
      const resolved = await resolveEventInfo(event);
      if (!resolved) {
        showInvalid('‚ùå No event selected. Please choose an event first.');
        return;
      }

      // compute breakdown and total from resolved.prices
      const priceList = resolved.prices || [];
      let qtyLeft = Number.isFinite(quantity) ? quantity : 1;
      if (!Number.isFinite(quantity) || quantity < 1) {
        showInvalid('‚ùå Invalid ticket quantity. Please select a positive number of tickets.');
        return;
      }
      let breakdown = [];
      let total = 0;
      for (let p of priceList) {
        if (qtyLeft <= 0) break;
        const take = Math.min(p.stock == null ? qtyLeft : p.stock, qtyLeft);
        if (take > 0) {
          breakdown.push({ price: p.price, count: take });
          total += p.price * take;
          qtyLeft -= take;
        }
      }

      // If qtyLeft > 0 after attempting to allocate from stock, there isn't enough stock
      if (qtyLeft > 0) {
        // compute total available stock
        const totalStock = priceList.reduce((s, p) => s + (Number.isFinite(p.stock) ? p.stock : 0), 0);
        showInvalid(`‚ùå Not enough tickets available. Only ${totalStock} left.`);
        return;
      }

      // populate summary
      document.getElementById('payment-summary').textContent =
        `üìã Event: ${resolved.name} | Tickets: ${quantity} | Total: Rp ${total.toLocaleString('id-ID')}`;

      // expose resolved info for the rest of the script
      window.__resolvedEvent = resolved;
      window.__resolvedBreakdown = breakdown;
      window.__resolvedTotal = total;

      // proceed to set up payment handlers below
    })();

    // Set up back button FIRST - always available
    console.log('Setting up back button listener...');
    const backBtn = document.getElementById('back-ticket');
    if (backBtn) {
      backBtn.addEventListener('click', function() {
        console.log('Back button clicked');
        // Use browser history to go back to previous page
        window.history.back();
      });
    } else {
      console.error('Back button not found!');
    }

    function showInvalid(message) {
      document.getElementById('payment-summary').textContent = message;
      document.querySelectorAll('.payment-form').forEach(f => f.style.display = 'none');
      document.querySelector('.payment-method-section').style.display = 'none';
      document.getElementById('payment-message').textContent = '';
    }

    // Payment method switcher
    document.querySelectorAll('.method-option').forEach(option => {
        option.addEventListener('click', function(e) {
          const method = this.getAttribute('data-method');
          document.querySelectorAll('.method-option').forEach(o => o.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.payment-form').forEach(f => f.classList.add('hidden-form'));
          document.getElementById(method + '-form').classList.remove('hidden-form');
        });
      });

      // Also handle radio button changes
      document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const method = this.value;
          document.querySelectorAll('.method-option').forEach(o => o.classList.remove('active'));
          document.querySelector(`[data-method="${method}"]`).classList.add('active');
          document.querySelectorAll('.payment-form').forEach(f => f.classList.add('hidden-form'));
          document.getElementById(method + '-form').classList.remove('hidden-form');
        });
      });

      // Card form handler
      document.getElementById('card-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const holder = document.getElementById('card-holder').value.trim();
        const number = document.getElementById('card-number').value.trim().replace(/\s/g, '');
        const expiry = document.getElementById('card-expiry').value.trim();
        const cvv = document.getElementById('card-cvv').value.trim();

        if (!holder || number.length < 13 || !expiry.match(/^\d{2}\/\d{2}$/) || cvv.length < 3) {
          showMessage('Please enter valid card details.', 'error');
          return;
        }
        processPayment('Credit Card', `${number.slice(-4)}`);
      });

      // E-Wallet form handler
      document.getElementById('ewallet-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const provider = document.getElementById('ewallet-provider').value;
        const phone = document.getElementById('ewallet-phone').value.trim();
        if (!provider || !phone) {
          showMessage('Please select a provider and enter your account.', 'error');
          return;
        }
        processPayment(provider.toUpperCase(), phone);
      });

      document.getElementById('bank-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const bank = document.getElementById('bank-name').value;
        const account = document.getElementById('bank-account').value.trim();
        const name = document.getElementById('bank-name-acc').value.trim();
        if (!bank || !account || !name) {
          showMessage('Please fill in all bank details.', 'error');
          return;
        }
        processPayment(bank.toUpperCase() + ' Transfer', account.slice(-4));
      });

      async function processPayment(method, ref) {
        // Disable submit buttons
        document.querySelectorAll('button[type="submit"]').forEach(b => b.disabled = true);
        showMessage('Processing payment...', '');

        const resolved = window.__resolvedEvent || {};
        const eventId = resolved.id != null ? resolved.id : (resolved.name || event);

        try {
          const resp = await fetch('/tickets/purchase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ eventId, quantity })
          });
          const data = await resp.json();
          if (!resp.ok) {
            // show server error
            if (data && data.available != null) {
              showInvalid(`‚ùå Not enough tickets available. Only ${data.available} left.`);
            } else {
              showMessage(data.error || 'Purchase failed on server.', 'error');
            }
            document.querySelectorAll('button[type="submit"]').forEach(b => b.disabled = false);
            return;
          }

          // success: use returned breakdown to compute total if desired
          const breakdown = data.breakdown || window.__resolvedBreakdown || [];
          const totalValue = breakdown.reduce((s, b) => s + (b.price * b.count), 0) || window.__resolvedTotal || 0;
          const eventLabel = resolved.name || eventNames[event] || String(event);
          document.querySelectorAll('.payment-form').forEach(f => f.style.display = 'none');
          document.querySelector('.payment-method-section').style.display = 'none';
          showMessage(
            `‚úÖ Payment successful!\nMethod: ${method} (${ref})\nTickets: ${quantity} x ${eventLabel}\nTotal: Rp ${totalValue.toLocaleString('id-ID')}\n\nCheck your email for tickets.`,
            'success'
          );

        } catch (err) {
          console.error('Purchase error', err);
          showMessage('Network error during purchase.', 'error');
          document.querySelectorAll('button[type="submit"]').forEach(b => b.disabled = false);
        }
      }

      function showMessage(msg, type) {
        const msgEl = document.getElementById('payment-message');
        msgEl.textContent = msg;
        msgEl.className = type;
      }
  </script>
</body>
</html>